<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated Chess Puzzles</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    
    <style>
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        h1 { text-align: center; color: #1a1a1a; margin-bottom: 40px; }
        
        #puzzle-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 25px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .puzzle-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }

        .board { width: 100%; max-width: 320px; margin: 0 auto 10px auto; }

        .engine-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #e9ecef;
        }

        .eval-btn {
            width: 100%;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        .eval-btn:hover { background: #2980b9; }

        /* Hidden by default until button click */
        .analysis-results {
            display: none; 
            margin-top: 10px;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }

        .depth-indicator {
            font-size: 0.7em;
            color: #95a5a6;
            text-align: right;
            display: block;
            margin-bottom: 5px;
        }

        .eval-row {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85em;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: flex-start;
        }
        .eval-score { 
            font-weight: bold; 
            min-width: 45px; 
            background: #34495e; 
            color: white; 
            padding: 2px 4px; 
            border-radius: 3px;
            text-align: center;
            margin-right: 10px;
        }
        .eval-line { color: #2c3e50; line-height: 1.4; word-break: break-word; }

        .info { font-size: 0.85em; margin-top: 10px; min-height: 60px; }
        .label { font-weight: bold; color: #95a5a6; text-transform: uppercase; font-size: 0.7em; }
        .theme-tag { 
            color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; 
            margin-right: 4px; margin-top: 4px; display: inline-block;
            text-shadow: 1px 1px 0px rgba(0,0,0,0.1);
        }
        .loading { text-align: center; padding: 50px; font-size: 1.2em; color: #666; }
    </style>
</head>
<body>

    <h1>Generated Chess Puzzles</h1>
    <div id="loading" class="loading">Parsing puzzle data...</div>
    <div id="puzzle-container"></div>

    <!-- Logic Dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        const DATA_URL = 'https://raw.githubusercontent.com/naapeli/Generating-open-source-chess-puzzles/refs/heads/main/src/generated_fens2.txt';
        
        // Stockfish Init using Proxy Blob to handle local file/CORS security
        let stockfish;
        try {
            const proxyScript = `importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');`;
            const blob = new Blob([proxyScript], { type: 'application/javascript' });
            stockfish = new Worker(URL.createObjectURL(blob));
        } catch (e) { console.error("Stockfish failed to start:", e); }

        let currentAnalysisId = null;
        let currentFen = "";

        stockfish.onmessage = function(event) {
            const line = event.data;
            if (line.includes('info depth') && line.includes('multipv')) {
                updateAnalysisUI(line);
            }
        };

        // Convert Engine moves (e2e4) to SAN (e4)
        function translateLineToSan(fen, uciLine) {
            const tempGame = new Chess(fen);
            const moves = uciLine.split(' ');
            const sanMoves = [];

            for (let move of moves) {
                const result = tempGame.move({
                    from: move.substring(0, 2),
                    to: move.substring(2, 4),
                    promotion: move.substring(4) || 'q'
                });
                if (result) sanMoves.push(result.san);
                else break;
            }
            return sanMoves.join(' ');
        }

        function updateAnalysisUI(line) {
            const depth = line.match(/depth (\d+)/)?.[1];
            const multipv = line.match(/multipv (\d+)/)?.[1];
            const scoreMatch = line.match(/score cp (-?\d+)/);
            const mateMatch = line.match(/score mate (-?\d+)/);
            const pv = line.split(' pv ')[1];

            if (!multipv || !currentAnalysisId) return;

            let score = "0.0";
            if (mateMatch) score = "#" + mateMatch[1];
            else if (scoreMatch) score = (parseInt(scoreMatch[1]) / 100).toFixed(1);

            const sanLine = translateLineToSan(currentFen, pv);
            const rowEl = document.getElementById(`${currentAnalysisId}-res-${multipv}`);
            const depthEl = document.getElementById(`${currentAnalysisId}-depth`);
            
            if (rowEl) rowEl.innerHTML = `<span class="eval-score">${score}</span><span class="eval-line">${sanLine}</span>`;
            if (depthEl) depthEl.innerText = `Depth: ${depth}/20`;
        }

        function runAnalysis(fen, boardId) {
            currentAnalysisId = boardId;
            currentFen = fen;
            
            // 1. Show the hidden results section for this card
            document.getElementById(`${boardId}-results-area`).style.display = 'block';

            // 2. Reset UI state
            document.getElementById(`${boardId}-depth`).innerText = 'Calculating...';
            for(let i=1; i<=5; i++) {
                document.getElementById(`${boardId}-res-${i}`).innerHTML = '<small>Waiting for engine...</small>';
            }

            // 3. Send commands to Stockfish
            stockfish.postMessage('stop');
            stockfish.postMessage('ucinewgame');
            stockfish.postMessage('setoption name MultiPV value 5');
            stockfish.postMessage(`position fen ${fen}`);
            stockfish.postMessage('go depth 20'); 
        }

        function stringToHslColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash % 360)}, 60%, 45%)`;
        }

        function init() {
            Papa.parse(DATA_URL, {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    renderBoards(results.data);
                }
            });
        }

        function renderBoards(data) {
            const container = document.getElementById('puzzle-container');
            document.getElementById('loading').style.display = 'none';

            data.forEach((row, i) => {
                const [idx, fen, rating, themesRaw, legal] = row;
                if (!fen) return;

                const boardId = `board-${i}`;
                const themeHtml = (themesRaw || "").split(/\s+/).map(t => 
                    `<span class="theme-tag" style="background:${stringToHslColor(t)}">${t}</span>`
                ).join('');

                const card = document.createElement('div');
                card.className = 'puzzle-card';
                card.innerHTML = `
                    <div id="${boardId}" class="board"></div>
                    <div class="info">
                        <span class="label">Puzzle Index: ${idx || (i+1)}</span><br>
                        <span class="label">Rating: ${rating}</span>
                        <div>${themeHtml}</div>
                    </div>
                    <div class="engine-section">
                        <button class="eval-btn" onclick="runAnalysis('${fen}', '${boardId}')">Analyze with Stockfish</button>
                        
                        <div id="${boardId}-results-area" class="analysis-results">
                            <span id="${boardId}-depth" class="depth-indicator">Depth: 0/20</span>
                            <div class="eval-row" id="${boardId}-res-1"></div>
                            <div class="eval-row" id="${boardId}-res-2"></div>
                            <div class="eval-row" id="${boardId}-res-3"></div>
                            <div class="eval-row" id="${boardId}-res-4"></div>
                            <div class="eval-row" id="${boardId}-res-5"></div>
                        </div>
                    </div>
                `;

                container.appendChild(card);

                Chessboard(boardId, {
                    position: fen.split(' ')[0],
                    showNotation: true,
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
                });
            });
        }

        $(document).ready(init);
    </script>
</body>
</html>